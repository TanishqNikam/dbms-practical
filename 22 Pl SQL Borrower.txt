-- Create the database and select it
CREATE DATABASE library;
USE library;

-- Create Borrower table
CREATE TABLE Borrower (
    Rollno INT(4),
    Name VARCHAR(20),
    DateofIssue DATE,
    NameofBook VARCHAR(30),
    Status VARCHAR(10)
);

-- Insert sample data into Borrower table
INSERT INTO Borrower VALUES (14, 'Ram', '2024-10-19', 'Operating System', 'I');
INSERT INTO Borrower VALUES (27, 'Soham', '2024-10-24', 'Object Oriented Programming', 'I');
INSERT INTO Borrower VALUES (34, 'Mohan', '2024-09-12', 'Microprocessor', 'I');
INSERT INTO Borrower VALUES (48, 'Om', '2024-09-19', 'Mechanics', 'I');

-- Check contents of Borrower table
SELECT * FROM Borrower;

-- Create Fine table
CREATE TABLE Fine (
    Rollno INT(4),
    Date DATE,
    Amount INT(10)
);

-- Set delimiter to define procedures
DELIMITER //

-- Create procedure to calculate fine with exception handling
CREATE PROCEDURE calc_Fine(IN r INT(10), IN b VARCHAR(30))
BEGIN
    DECLARE doi DATE;
    DECLARE diff INT(3);
    DECLARE CONTINUE HANDLER FOR NOT FOUND 
        BEGIN
            SIGNAL SQLSTATE '45000' 
            SET MESSAGE_TEXT = 'No matching Borrower record found for the given roll number and book name';
        END;
    
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
        BEGIN
            ROLLBACK;
            SIGNAL SQLSTATE '45000' 
            SET MESSAGE_TEXT = 'An error occurred while calculating fine.';
        END;

    -- Start transaction
    START TRANSACTION;

    -- Get DateofIssue for the given roll number and book name
    SELECT DateofIssue INTO doi FROM Borrower WHERE Rollno = r AND NameofBook = b;

    -- Calculate the number of days overdue
    SELECT DATEDIFF(CURDATE(), doi) INTO diff;

    -- Apply fine conditions
    IF diff >= 15 AND diff <= 30 THEN
        INSERT INTO Fine VALUES (r, CURDATE(), diff * 5);
    ELSEIF diff > 30 THEN
        INSERT INTO Fine VALUES (r, CURDATE(), diff * 50);
    END IF;

    -- Commit transaction
    COMMIT;
END//



-- Reset delimiter back to default
DELIMITER ;

-- Test the procedures
CALL calc_Fine(14, 'Operating System'); 
SELECT * FROM Fine; 

CALL calc_Fine(27, 'Object Oriented Programming'); 
CALL calc_Fine(34, 'Microprocessor'); 
CALL calc_Fine(48, 'Mechanics'); 
SELECT * FROM Fine;



-- Verify tables after submissions
SELECT * FROM Fine; 
SELECT * FROM Borrower;
